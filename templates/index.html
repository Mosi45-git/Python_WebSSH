<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSSH - 在线SSH终端</title>
    
    <!-- xterm.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            background-color: #1e1e1e;
            color: #ffffff;
            font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace;
        }
        
        .terminal-container {
            height: calc(100vh - 120px);
            background-color: #000000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        .connection-panel {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-connected {
            background-color: #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
        }
        
        .status-disconnected {
            background-color: #dc3545;
        }
        
        .connection-item {
            background-color: #3d3d3d;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .connection-item:hover {
            background-color: #4d4d4d;
            transform: translateY(-1px);
        }
        
        .connection-item.active {
            background-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.4);
        }
        
        .btn-terminal {
            background-color: #007bff;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-terminal:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        
        .form-control-terminal {
            background-color: #3d3d3d;
            border: 1px solid #555;
            color: #ffffff;
            border-radius: 6px;
        }
        
        .form-control-terminal:focus {
            background-color: #3d3d3d;
            border-color: #007bff;
            color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .terminal-header {
            background-color: #2d2d2d;
            padding: 10px 15px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .terminal-title {
            font-size: 14px;
            color: #ccc;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert-terminal {
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: #ffffff;
            border-radius: 6px;
        }
        
        .terminal-content {
            position: relative;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 标题栏 -->
        <div class="row mb-3">
            <div class="col-12">
                <h1 class="text-center mb-0">
                    <i class="fas fa-terminal"></i> WebSSH 在线终端
                </h1>
            </div>
        </div>
        
        <div class="row">
            <!-- 连接管理面板 -->
            <div class="col-md-3">
                <div class="connection-panel">
                    <h5><i class="fas fa-plug"></i> SSH连接管理</h5>
                    
                    <!-- 连接表单 -->
                    <form id="connectionForm" class="mb-3">
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-terminal" id="host" placeholder="主机地址" value="localhost" required>
                        </div>
                        <div class="mb-2">
                            <input type="number" class="form-control form-control-terminal" id="port" placeholder="端口" value="22" required>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-terminal" id="username" placeholder="用户名" value="root" required>
                        </div>
                        <div class="mb-2">
                            <input type="password" class="form-control form-control-terminal" id="password" placeholder="密码">
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control form-control-terminal" id="privateKey" rows="3" placeholder="私钥内容（可选）"></textarea>
                        </div>
                        <button type="submit" class="btn btn-terminal w-100">
                            <i class="fas fa-link"></i> 连接
                        </button>
                    </form>
                    
                    <hr style="border-color: #555;">
                    
                    <!-- 连接列表 -->
                    <h6><i class="fas fa-list"></i> 活动连接</h6>
                    <div id="connectionsList">
                        <p class="text-muted">暂无连接</p>
                    </div>
                </div>
            </div>
            
            <!-- 终端面板 -->
            <div class="col-md-9">
                <div class="terminal-container">
                    <div class="terminal-header">
                        <div class="terminal-title">
                            <span id="connectionStatus" class="status-indicator status-disconnected"></span>
                            <span id="connectionInfo">未连接</span>
                        </div>
                        <div>
                            <button id="clearTerminal" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="fas fa-eraser"></i> 清屏
                            </button>
                            <button id="disconnectBtn" class="btn btn-sm btn-outline-danger" disabled>
                                <i class="fas fa-unlink"></i> 断开
                            </button>
                        </div>
                    </div>
                    <div class="terminal-content">
                        <div id="terminal"></div>
                        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- xterm.js JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        class WebSSHClient {
            constructor() {
                this.socket = null;
                this.terminal = null;
                this.fitAddon = null;
                this.currentSSHId = null;
                this.connections = new Map();
                
                this.initializeTerminal();
                this.initializeSocket();
                this.bindEvents();
            }
            
            initializeTerminal() {
                // 创建终端实例
                this.terminal = new Terminal({
                    cursorBlink: true,
                    cursorStyle: 'block',
                    fontSize: 14,
                    fontFamily: 'Consolas, Monaco, Lucida Console, monospace',
                    theme: {
                        background: '#000000',
                        foreground: '#ffffff',
                        cursor: '#ffffff',
                        selection: '#ffffff33',
                        black: '#000000',
                        red: '#ff0000',
                        green: '#00ff00',
                        yellow: '#ffff00',
                        blue: '#0000ff',
                        magenta: '#ff00ff',
                        cyan: '#00ffff',
                        white: '#ffffff',
                        brightBlack: '#808080',
                        brightRed: '#ff8080',
                        brightGreen: '#80ff80',
                        brightYellow: '#ffff80',
                        brightBlue: '#8080ff',
                        brightMagenta: '#ff80ff',
                        brightCyan: '#80ffff',
                        brightWhite: '#ffffff'
                    },
                    allowTransparency: false,
                    rows: 24,
                    cols: 80
                });
                
                // 添加自适应插件
                this.fitAddon = new FitAddon.FitAddon();
                this.terminal.loadAddon(this.fitAddon);
                
                // 打开终端
                const terminalElement = document.getElementById('terminal');
                this.terminal.open(terminalElement);
                
                // 自适应终端大小
                setTimeout(() => {
                    this.fitAddon.fit();
                }, 100);
                
                // 监听终端输入
                this.terminal.onData(data => {
                    if (this.currentSSHId) {
                        this.socket.emit('terminal_input', { data: data });
                    }
                });
                
                // 监听终端大小变化
                window.addEventListener('resize', () => {
                    setTimeout(() => {
                        this.fitAddon.fit();
                        if (this.currentSSHId) {
                            this.socket.emit('resize_terminal', {
                                cols: this.terminal.cols,
                                rows: this.terminal.rows
                            });
                        }
                    }, 100);
                });
            }
            
            initializeSocket() {
                // 连接WebSocket服务器
                this.socket = io.connect(window.location.origin, {
                    transports: ['websocket'],
                    reconnection: true,
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000
                });
                
                // WebSocket事件监听
                this.socket.on('connect', () => {
                    this.showMessage('WebSocket连接成功', 'success');
                    this.socket.emit('list_connections');
                });
                
                this.socket.on('disconnect', () => {
                    this.showMessage('WebSocket连接断开', 'warning');
                });
                
                this.socket.on('error', (data) => {
                    this.showMessage(data.message || '发生错误', 'danger');
                    this.hideLoading();
                });
                
                // SSH连接事件
                this.socket.on('ssh_connected', (data) => {
                    this.hideLoading();
                    if (data.success) {
                        this.currentSSHId = data.ssh_id;
                        this.connections.set(data.ssh_id, {
                            id: data.ssh_id,
                            connected: true
                        });
                        this.updateConnectionStatus();
                        this.updateConnectionsList();
                        this.showMessage(data.message, 'success');
                    } else {
                        this.showMessage(data.error || '连接失败', 'danger');
                    }
                });
                
                this.socket.on('ssh_disconnected', (data) => {
                    if (data.success) {
                        this.connections.delete(data.ssh_id);
                        if (this.currentSSHId === data.ssh_id) {
                            this.currentSSHId = null;
                            this.terminal.clear();
                            this.terminal.write('\r\n\x1b[31mSSH连接已断开\x1b[0m\r\n');
                        }
                        this.updateConnectionStatus();
                        this.updateConnectionsList();
                        this.showMessage(data.message, 'info');
                    }
                });
                
                this.socket.on('ssh_switched', (data) => {
                    if (data.success) {
                        this.currentSSHId = data.ssh_id;
                        this.terminal.clear();
                        this.updateConnectionStatus();
                        this.showMessage(data.message, 'success');
                    }
                });
                
                // 终端输出事件
                this.socket.on('terminal_output', (data) => {
                    if (data.ssh_id === this.currentSSHId) {
                        this.terminal.write(data.data);
                    }
                });
                
                // 连接列表事件
                this.socket.on('connections_list', (data) => {
                    this.connections.clear();
                    data.connections.forEach(conn => {
                        this.connections.set(conn.id, conn);
                    });
                    this.updateConnectionsList();
                });
            }
            
            bindEvents() {
                // 连接表单提交
                document.getElementById('connectionForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createSSHConnection();
                });
                
                // 清屏按钮
                document.getElementById('clearTerminal').addEventListener('click', () => {
                    this.terminal.clear();
                });
                
                // 断开连接按钮
                document.getElementById('disconnectBtn').addEventListener('click', () => {
                    if (this.currentSSHId) {
                        this.socket.emit('disconnect_ssh', { ssh_id: this.currentSSHId });
                    }
                });
            }
            
            createSSHConnection() {
                const formData = {
                    host: document.getElementById('host').value,
                    port: parseInt(document.getElementById('port').value),
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value,
                    private_key: document.getElementById('privateKey').value
                };
                
                if (!formData.host || !formData.username) {
                    this.showMessage('请填写完整的主机信息', 'warning');
                    return;
                }
                
                this.showLoading();
                this.socket.emit('create_ssh_connection', formData);
            }
            
            switchSSHConnection(sshId) {
                if (sshId !== this.currentSSHId) {
                    this.socket.emit('switch_ssh_connection', { ssh_id: sshId });
                }
            }
            
            updateConnectionStatus() {
                const statusIndicator = document.getElementById('connectionStatus');
                const connectionInfo = document.getElementById('connectionInfo');
                const disconnectBtn = document.getElementById('disconnectBtn');
                
                if (this.currentSSHId && this.connections.has(this.currentSSHId)) {
                    const conn = this.connections.get(this.currentSSHId);
                    statusIndicator.className = 'status-indicator status-connected';
                    connectionInfo.textContent = `已连接: ${conn.username}@${conn.host}:${conn.port}`;
                    disconnectBtn.disabled = false;
                } else {
                    statusIndicator.className = 'status-indicator status-disconnected';
                    connectionInfo.textContent = '未连接';
                    disconnectBtn.disabled = true;
                }
            }
            
            updateConnectionsList() {
                const connectionsList = document.getElementById('connectionsList');
                
                if (this.connections.size === 0) {
                    connectionsList.innerHTML = '<p class="text-muted">暂无连接</p>';
                    return;
                }
                
                let html = '';
                this.connections.forEach((conn, sshId) => {
                    const isActive = sshId === this.currentSSHId;
                    html += `
                        <div class="connection-item ${isActive ? 'active' : ''}" onclick="webssh.switchSSHConnection('${sshId}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="status-indicator ${conn.connected ? 'status-connected' : 'status-disconnected'}"></span>
                                    <strong>${conn.username}@${conn.host}</strong>
                                    <small class="text-muted d-block">端口: ${conn.port}</small>
                                </div>
                                <small class="text-muted">ID: ${sshId.substring(0, 8)}</small>
                            </div>
                        </div>
                    `;
                });
                
                connectionsList.innerHTML = html;
            }
            
            showLoading() {
                document.getElementById('loadingOverlay').style.display = 'flex';
            }
            
            hideLoading() {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
            
            showMessage(message, type = 'info') {
                const alertClass = {
                    'success': 'alert-success',
                    'danger': 'alert-danger',
                    'warning': 'alert-warning',
                    'info': 'alert-info'
                }[type] || 'alert-info';
                
                const alertHtml = `
                    <div class="alert ${alertClass} alert-terminal alert-dismissible fade show" role="alert">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = alertHtml;
                document.body.insertBefore(tempDiv.firstChild, document.body.firstChild);
                
                // 5秒后自动消失
                setTimeout(() => {
                    const alert = document.querySelector('.alert');
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
        }
        
        // 初始化WebSSH客户端
        const webssh = new WebSSHClient();
        
        // 全局函数供HTML调用
        window.webssh = webssh;
    </script>
</body>
</html>